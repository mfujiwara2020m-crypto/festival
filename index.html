<!DOCTYPE html>
<html>
<head>
    <title>A-Frame AR.js Hiro Marker Scene (Rotating Gears)</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <script>
        AFRAME.registerComponent('ar-persistent', {
            init: function () {
                const el = this.el;
                const marker = el.parentNode;
                let hasBeenFound = false;

                // マーカー検出時の処理
                marker.addEventListener('markerFound', () => {
                    if (!hasBeenFound) {
                        // 1. まず表示する
                        el.setAttribute('visible', true);
                        
                        // 2. エンティティのワールド座標と回転を取得
                        const worldPosition = el.object3D.getWorldPosition(new THREE.Vector3());
                        const worldRotation = el.object3D.rotation;
                        
                        // 3. マーカーから切り離し、<a-scene>の直下へ移動
                        const scene = el.sceneEl;
                        el.setAttribute('position', worldPosition); // ワールド座標をローカル座標として設定
                        el.setAttribute('rotation', {
                            x: THREE.MathUtils.radToDeg(worldRotation.x),
                            y: THREE.MathUtils.radToDeg(worldRotation.y),
                            z: THREE.MathUtils.radToDeg(worldRotation.z)
                        });
                        
                        // 親要素から削除し、シーンに追加
                        marker.removeChild(el);
                        scene.appendChild(el);
                        
                        hasBeenFound = true;
                        console.log('Marker found, element detached and persistent.');
                    }
                });
                
                // markerLost時の処理は不要（既にデタッチされているため）
            }
        });
    </script>
</head>
<body>

<a-scene embedded arjs='sourceType: webcam; detectionMode: mono_and_matrix; matrixCodeType: 3x3;'>
    <a-assets>
        <img id="charactor-img" src="original.png">
        <img id="gear-img" src="gear.png">
        <img id="heart-img" src="heart.png">
    </a-assets>

    <a-marker preset='hiro'>
        <a-image src="#charactor-img"
                 position="0 -1.5 -10"
                 scale="8 8 8"
                 rotation="0 0 0"
                 visible="false" 
                 ar-persistent></a-image>

        <a-image src="#heart-img"
                 position="0.5 -1 -5.0"
                 scale="2 2 2"  
                 rotation="0 0 0"
                 visible="false" 
                 ar-persistent></a-image>

        <a-image src="#gear-img"
                 position="3 2 -4.9" 
                 scale="1.5 1.5 1.5" 
                 rotation="0 0 0"
                 animation="property: rotation; to: 0 0 360; loop: true; easing: linear; dur: 6000;"
                 visible="false" 
                 ar-persistent></a-image> 

        <a-image src="#gear-img"
                 position="3 1 -4.9" 
                 scale="1.5 1.5 1.5" 
                 rotation="0 0 30"
                 animation="property: rotation; to: 0 0 -360; loop: true; easing: linear; dur: 4000;"
                 visible="false" 
                 ar-persistent></a-image> 

        <a-image src="#gear-img"
                 position="3 0 -4.9" 
                 scale="1.5 1.5 1.5" 
                 rotation="0 0 -30"
                 animation="property: rotation; to: 0 0 360; loop: true; easing: linear; dur: 6000;"
                 visible="false" 
                 ar-persistent></a-image> 
    </a-marker>

    <a-entity camera></a-entity>

</a-scene>
</body>
</html>

