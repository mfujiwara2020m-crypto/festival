<!DOCTYPE html>
<html>
<head>
    <title>A-Frame AR.js Hiro Marker Scene (Rotating Gears)</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <script>
        AFRAME.registerComponent('ar-persistent', {
            init: function () {
                const el = this.el;
                const marker = el.parentNode;
                
                // 初回マーカー検出時のみ実行するためのフラグ
                let hasBeenFound = false; 

                // マーカー検出時の処理
                const onMarkerFound = () => {
                    if (hasBeenFound) return;
                    
                    // 1. まず表示する
                    el.setAttribute('visible', true);
                    
                    // 2. ワールド座標を取得するために、three.jsのオブジェクトをラップします。
                    // A-Frameのオブジェクトは three.js の Mesh を持ちます。
                    const obj3d = el.object3D;
                    const worldPosition = new THREE.Vector3();
                    const worldQuaternion = new THREE.Quaternion();
                    const worldScale = new THREE.Vector3();
                    
                    // ワールド座標と回転、スケールを取得
                    obj3d.matrixWorld.decompose(worldPosition, worldQuaternion, worldScale);
                    
                    // 3. マーカーから切り離し、<a-scene>の直下へ移動
                    const scene = el.sceneEl;
                    
                    // ワールド座標をシーンに対するローカル座標として再設定
                    el.setAttribute('position', worldPosition);
                    el.setAttribute('rotation', {
                        x: THREE.MathUtils.radToDeg(worldQuaternion.x), // Quaternionの値をEuler角に変換
                        y: THREE.MathUtils.radToDeg(worldQuaternion.y),
                        z: THREE.MathUtils.radToDeg(worldQuaternion.z)
                    });
                    
                    // scaleはそのまま使用
                    el.setAttribute('scale', worldScale); 

                    // 親要素から削除し、シーンに追加
                    marker.removeChild(el);
                    scene.appendChild(el);
                    
                    hasBeenFound = true;
                    
                    // イベントリスナーはもう必要ないので削除しても良い
                    // marker.removeEventListener('markerFound', onMarkerFound);
                    console.log('Marker found, element detached and persistent.');
                };

                marker.addEventListener('markerFound', onMarkerFound);
            }
        });
    </script>
</head>
<body>

<a-scene embedded arjs='sourceType: webcam; detectionMode: mono_and_matrix; matrixCodeType: 3x3;'>
    <a-assets>
        <img id="charactor-img" src="original.png">
        <img id="gear-img" src="gear.png">
        <img id="heart-img" src="heart.png">
    </a-assets>

    <a-marker preset='hiro'>
        <a-image src="#charactor-img"
                 position="0 -1.5 -10"
                 scale="8 8 8"
                 rotation="0 0 0"
                 visible="false" 
                 ar-persistent></a-image>

        <a-image src="#heart-img"
                 position="0.5 -1 -5.0"
                 scale="2.5 2.5 2.5"  
                 rotation="0 0 0"
                 visible="false" 
                 ar-persistent></a-image>

        <a-image src="#gear-img"
                 position="3 1.5 -4.9" 
                 scale="1.5 1.5 1.5" 
                 rotation="0 0 0"
                 animation="property: rotation; to: 0 0 360; loop: true; easing: linear; dur: 6000;"
                 visible="false" 
                 ar-persistent></a-image> 

        <a-image src="#gear-img"
                 position="3 0.5 -4.9" 
                 scale="1.5 1.5 1.5" 
                 rotation="0 0 30"
                 animation="property: rotation; to: 0 0 -360; loop: true; easing: linear; dur: 4000;"
                 visible="false" 
                 ar-persistent></a-image> 

        <a-image src="#gear-img"
                 position="3 -0.5 -4.9" 
                 scale="1.5 1.5 1.5" 
                 rotation="0 0 -30"
                 animation="property: rotation; to: 0 0 360; loop: true; easing: linear; dur: 6000;"
                 visible="false" 
                 ar-persistent></a-image> 
    </a-marker>

    <a-entity camera></a-entity>

</a-scene>
</body>
</html>
