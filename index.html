<!DOCTYPE html>
<html>
<head>
    <title>A-Frame AR.js Hiro Marker Scene (Rotating Gears)</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <script>
        AFRAME.registerComponent('ar-visibility-toggle', {
            init: function () {
                const marker = this.el.parentNode;

                // マーカーが検出されたときのみ表示する
                marker.addEventListener('markerFound', () => {
                    this.el.setAttribute('visible', true);
                    // マーカーが一度認識された後は、イベントリスナーを削除することで
                    // 以降の markerLost イベントの影響を受けないようにする
                    marker.removeEventListener('markerLost', this.hideElement);
                    console.log('Marker found, element shown and visibility locked.');
                });
                
                // markerLost イベントで非表示にする処理は削除します。
                // ただし、AR.jsはマーカーが外れるとエンティティの位置をリセットしようとするため、
                // A-Frameの仕組み上、 visible:true にしたままではオブジェクトは画面から消えます。
                // したがって、このロジックは「マーカーが検出されたら表示し、その後は非表示にしない」という
                // 動作になりますが、AR.jsの制御下にある限り、マーカーが失われるとオブジェクトはトラッキングを失い、
                // 最終的に画面から消えます。

                // A-Frame/AR.jsの標準的な動作では、マーカーが失われた後も表示し続けるには、
                // マーカー要素から切り離す**デタッチ**や、その時点の**ワールド座標を保持**する処理が必要になります。
                // 今回は「マーカーが見つかったら表示する」というロジックのみを保持し、
                // 意図的に非表示にすることをやめます。
            }
        });
    </script>
</head>
<body>

<a-scene embedded arjs='sourceType: webcam; detectionMode: mono_and_matrix; matrixCodeType: 3x3;'>
    <a-assets>
        <img id="charactor-img" src="original.png">
        <img id="gear-img" src="gear.png">
        <img id="heart-img" src="heart.png">
    </a-assets>

    <a-marker preset='hiro'>
        <a-image src="#charactor-img"
                 position="0 -1.5 -10"
                 scale="8 8 8"
                 rotation="0 0 0"
                 visible="false" 
                 ar-visibility-toggle></a-image>

        <a-image src="#heart-img"
                 position="0.5 -1 -5.0"
                 scale="2.5 2.5 2.5"  
                 rotation="0 0 0"
                 visible="false" 
                 ar-visibility-toggle></a-image>

        <a-image src="#gear-img"
                 position="3 1.5 -4.9" 
                 scale="1.5 1.5 1.5" 
                 rotation="0 0 0"
                 animation="property: rotation; to: 0 0 360; loop: true; easing: linear; dur: 6000;"
                 visible="false" 
                 ar-visibility-toggle></a-image> 

        <a-image src="#gear-img"
                 position="3 0.5 -4.9" 
                 scale="1.5 1.5 1.5" 
                 rotation="0 0 30"
                 animation="property: rotation; to: 0 0 -360; loop: true; easing: linear; dur: 4000;"
                 visible="false" 
                 ar-visibility-toggle></a-image> 

        <a-image src="#gear-img"
                 position="3 -0.5 -4.9" 
                 scale="1.5 1.5 1.5" 
                 rotation="0 0 -30"
                 animation="property: rotation; to: 0 0 360; loop: true; easing: linear; dur: 6000;"
                 visible="false" 
                 ar-visibility-toggle></a-image> 
    </a-marker>

    <a-entity camera></a-entity>

</a-scene>
</body>
</html>
